# Test code for the postgresql_set module
# Copyright: (c) 2019, Andrew Klychkov (@Andersson007) <andrew.a.klychkov@gmail.com>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
#
# Notice: assertions are different for Ubuntu 16.04 and FreeBSD because they don't work
# correctly for these tests. There are some stranges exactly in Shippable CI.
# However I checked it manually for all points (including Ubuntu 16.05 and FreeBSD)
# and it worked as expected.

- vars:
    task_parameters: &task_parameters
      become_user: '{{ pg_user }}'
      become: true
      register: result
    pg_parameters: &pg_parameters
      login_user: '{{ pg_user }}'
      login_db: postgres

  block:
  - name: Set value same as default (4096kB) but in a different unit
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: work_mem
      value: 4MB

  - name: Check the result
    assert:
      that:
      - result is not changed

  - name: Set a different value
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: work_mem
      value: 2048

  - name: Check the result
    assert:
      that:
      - result is changed

  - name: Set a different value using units
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: work_mem
      value: 8MB

  - name: Check the result
    assert:
      that:
      - result is changed

  - name: Set a value with invalid unit
    <<: *task_parameters
    ignore_errors: true
    postgresql_alter_system:
      <<: *pg_parameters
      param: work_mem
      value: 8M

  - name: Check the result
    assert:
      that:
      - result is failed
      - result.msg is search("invalid value for parameter")

  - name: Set param of postmaster context
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: huge_page_size
      value: 2MB

  - name: Check the result
    assert:
      that:
      - result is changed
      - result.restart_required == True

  - name: Set param of internal context, must fail
    <<: *task_parameters
    ignore_errors: true
    postgresql_alter_system:
      <<: *pg_parameters
      param: block_size
      value: 1MB

  - name: Check the result
    assert:
      that:
      - result is failed
      - result.msg is search("cannot be changed")

  - name: Set a bool param
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: autovacuum
      value: off

  - name: Check the result
    assert:
      that:
      - result is changed

  - name: Set value with no unit
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: autovacuum_analyze_threshold
      value: 60

  - name: Check the result
    assert:
      that:
      - result is changed

  - name: Set same value with no unit again
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: autovacuum_analyze_threshold
      value: 60

  - name: Check the result
    assert:
      that:
      - result is not changed

  - name: Set value of type real
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: autovacuum_analyze_scale_factor
      value: 1

  - name: Check the result
    assert:
      that:
      - result is changed

  - name: Set value of type real again
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: autovacuum_analyze_scale_factor
      value: 1

  - name: Check the result
    assert:
      that:
      - result is not changed

  - name: Set value of type string
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: log_timezone
      value: Europe/Berlin

  - name: Check the result
    assert:
      that:
      - result is changed

  - name: Set value of type real again
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: log_timezone
      value: Europe/Berlin

  - name: Check the result
    assert:
      that:
      - result is not changed

  - name: Reset a parameter
    <<: *task_parameters
    postgresql_alter_system:
      <<: *pg_parameters
      param: log_timezone
      value: _RESET

  - name: Check the result
    assert:
      that:
      - result is changed

  # Finish this after completely implementing setting up regular values
  #- name: Set DEFAULT
  #  <<: *task_parameters
  #  postgresql_alter_system:
  #    <<: *pg_parameters
  #    param: work_mem
  #    value: _DEFAULT

  #- name: Check the result
  #  assert:
  #    that:
  #    - result is changed
  #    - result.executed_queries == ["ALTER SYSTEM SET work_mem = DEFAULT"]

